name: CI Pipeline (Docker Validation)

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "main"

jobs:
  docker-validate:
    runs-on: [self-hosted, windows]
    environment:
      name: production

    env:
      DOCKER_HOST: tcp://localhost:2375

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Verify package.json exists
        shell: powershell
        run: |
          if (!(Test-Path "backend/package.json")) {
            Write-Error "package.json not found in backend"
            exit 1
          }

      - name: Install dependencies
        working-directory: backend
        shell: powershell
        run: npm install
        continue-on-error: true

      - name: Run tests (non-blocking)
        working-directory: backend
        shell: powershell
        run: npm test --if-present
        continue-on-error: true

      - name: Build project
        working-directory: backend
        shell: powershell
        run: npm run build --if-present
        continue-on-error: true

      - name: Verify Docker is reachable
        shell: powershell
        run: docker info

      - name: Validate PORT from Environment
        shell: powershell
        run: |
          if (-not $Env:PORT) {
            Write-Error "PORT is missing from GitHub Environment secrets"
            exit 1
          }
          Write-Host "PORT resolved as $Env:PORT"

      - name: Build Docker image
        shell: powershell
        run: |
          docker build `
            -f backend/Dockerfile `
            -t ci-test:${{ github.sha }} `
            .

      - name: Stop existing test container
        shell: powershell
        run: docker rm -f ci-test
        continue-on-error: true

      - name: Run Docker container (kept running)
        shell: powershell
        run: |
          docker run -d `
            --name ci-test `
            -p $Env:PORT:$Env:PORT `
            -e PORT=$Env:PORT `
            -e MONGO_URI=${{ secrets.MONGO_URI }} `
            ci-test:${{ github.sha }}

      - name: Show container logs
        shell: powershell
        run: docker logs ci-test